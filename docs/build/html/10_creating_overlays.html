

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating Overlays &mdash; Python productivity for Zynq (Pynq) v1.0</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Python productivity for Zynq (Pynq) v1.0" href="index.html"/>
        <link rel="next" title="pynq Package" href="11_python_package.html"/>
        <link rel="prev" title="Audio using the Base Overlay" href="9c_base_overlay_audio.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Python productivity for Zynq (Pynq)
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1_getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_pynq.html">PYNQ Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_jupyter_notebook.html">Jupyter Notebook Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_programming_python.html">Cortex-A9 programming in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_programming_onboard.html">Programming PYNQ-Z1&#8217;s onboard peripherals</a></li>
<li class="toctree-l1"><a class="reference internal" href="6_overlays.html">Introduction to Overlays</a></li>
<li class="toctree-l1"><a class="reference internal" href="7_iop_architecture.html">IO Processor Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="8_iop_code.html">IO Processors: Writing Your Own Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="9a_base_overlay_iop.html">Using Peripherals with the Base overlay</a></li>
<li class="toctree-l1"><a class="reference internal" href="9b_base_overlay_video.html">Video using the Base Overlay</a></li>
<li class="toctree-l1"><a class="reference internal" href="9c_base_overlay_audio.html">Audio using the Base Overlay</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Creating Overlays</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#vivado-design">Vivado design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#block-diagram-tcl">Block Diagram Tcl</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ip-dict">ip_dict</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#existing-overlays">Existing Overlays</a></li>
<li class="toctree-l2"><a class="reference internal" href="#interfacing-to-an-overlay">Interfacing to an overlay</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mmio">MMIO</a></li>
<li class="toctree-l3"><a class="reference internal" href="#zynq-gpios">Zynq GPIOs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cffi">CFFI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#packaging-overlays">Packaging overlays</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-overlays">Using Overlays</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="11_python_package.html"><code class="docutils literal"><span class="pre">pynq</span></code> Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="12_verification.html">Verification</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html"><code class="docutils literal"><span class="pre">pynq</span></code> package reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="14_faqs.html">Frequently Asked Questions (FAQs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="15_glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="16_references.html">Useful Reference Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="17_appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="18_changelog.html">Documentation Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Python productivity for Zynq (Pynq)</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Creating Overlays</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/10_creating_overlays.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput > div,
div.nbinput div[class^=highlight],
div.nbinput div[class^=highlight] pre,
div.nboutput,
div.nboutput > div,
div.nboutput div[class^=highlight],
div.nboutput div[class^=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput > :first-child pre {
    color: navy;
}

/* output prompt */
div.nboutput > :first-child pre {
    color: darkred;
}

/* all prompts */
div.nbinput > :first-child[class^=highlight],
div.nboutput > :first-child[class^=highlight],
div.nboutput > :first-child {
    min-width: 11ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}

/* input/output area */
div.nbinput > :nth-child(2)[class^=highlight],
div.nboutput > :nth-child(2),
div.nboutput > :nth-child(2)[class^=highlight] {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
}

/* input area */
div.nbinput > :nth-child(2)[class^=highlight] {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput  > :nth-child(2).stderr {
    background: #fdd;
}

/* ANSI colors */
.ansiblack { color: black; }
.ansired { color: darkred; }
.ansigreen { color: darkgreen; }
.ansiyellow { color: #c4a000; }
.ansiblue { color: darkblue; }
.ansipurple { color: darkviolet; }
.ansicyan { color: steelblue; }
/* See https://github.com/jupyter/nbconvert/issues/174 */
.ansigray { color: gray; }  /* nbconvert CSS */
.ansigrey { color: gray; }  /* nbconvert HTML output */

.ansibgblack { background-color: black; }
.ansibgred { background-color: red; }
.ansibggreen { background-color: green; }
.ansibgyellow { background-color: yellow; }
.ansibgblue { background-color: blue; }
.ansibgpurple { background-color: magenta; }
.ansibgcyan { background-color: cyan; }
.ansibggray { background-color: gray; }

.ansibold { font-weight: bold; }
</style>
<div class="section" id="creating-overlays">
<h1><a class="toc-backref" href="#id1">Creating Overlays</a><a class="headerlink" href="#creating-overlays" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#creating-overlays" id="id1">Creating Overlays</a><ul>
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a></li>
<li><a class="reference internal" href="#vivado-design" id="id3">Vivado design</a></li>
<li><a class="reference internal" href="#existing-overlays" id="id4">Existing Overlays</a></li>
<li><a class="reference internal" href="#interfacing-to-an-overlay" id="id5">Interfacing to an overlay</a></li>
<li><a class="reference internal" href="#packaging-overlays" id="id6">Packaging overlays</a></li>
<li><a class="reference internal" href="#using-overlays" id="id7">Using Overlays</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>As described in the PYNQ introduction, overlays are analogous to software libraries. A programmer can download overlays into the Zynq® PL at runtime to provide functionality required by the software application.</p>
<p>An Overlay is a class of Programmable Logic design. Programmable Logic designs are usually highly optimized for a specific task. Overlays however, are designed to be configurable, and reusable for broad set of applications. A PYNQ overlay will have a Python interface, allowing a software programmer to use it like any other Python package.</p>
<p>A programmer can use an overlay, but will not usually create the overlays, as this is a specialised task for a hardware designer.</p>
<p>This section will give an overview of the process of creating an overlay and integrating it into PYNQ, but will not cover the hardware design process in detail.</p>
</div>
<div class="section" id="vivado-design">
<h2><a class="toc-backref" href="#id3">Vivado design</a><a class="headerlink" href="#vivado-design" title="Permalink to this headline">¶</a></h2>
<p>An overlay consists of two main parts; the Programmable Logic (PL) design, and the Python API.</p>
<p>Xilinx® Vivado software is used to create the PL design. This will generate a <em>bitstream</em> or <em>binary</em> file (.bit file) that is used to program the Zynq PL.</p>
<p>The free webpack version of Vivado can be used with the PYNQ-Z1 board to create overlays.
<a class="reference external" href="https://www.xilinx.com/products/design-tools/vivado/vivado-webpack.html">https://www.xilinx.com/products/design-tools/vivado/vivado-webpack.html</a></p>
<p>There are some differences between the standard Zynq design process, and designing overlays for PYNQ. A Vivado project for a Zynq design consists of two parts; the PL design, and the PS configuration settings. The PS configuration includes settings for system clocks, including the clocks used in the PL.</p>
<p>The PYNQ image which is used to boot the board configures the Zynq PS at boot time. Overlays are downloaded as required by the programmer, and will not reconfigure the Zynq PS. This means that overlay designers should ensure the PS settings in their Vivado project match the PYNQ image settings.</p>
<p>The following settings should be used for a new Vivado overlay project:</p>
<p>Vivado Project settings:</p>
<ul class="simple">
<li>Target device: xc7z020clg400-1</li>
</ul>
<p>PL clock configuration:</p>
<ul class="simple">
<li>FCLK_CLK0: 100.00MHz</li>
<li>FCLK_CLK1: 142.86MHz</li>
<li>FCLK_CLK2: 200.00MHz</li>
<li>FCLK_CLK3: 166.67MHz</li>
</ul>
<p>The PYNQ-Z1 Master XDC (I/O constraints) are available at the Digilent PYNQ-Z1 resource site:
<a class="reference external" href="https://reference.digilentinc.com/reference/programmable-logic/pynq-z1/start">https://reference.digilentinc.com/reference/programmable-logic/pynq-z1/start</a></p>
<p>It is recommended to start with an existing overlay design to ensure the PS settings are correct. The source files for the <em>base</em> overlay can be found in the pynq GitHub, and the project can be rebuilt using the makefile available here:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">&lt;GitHub</span> <span class="pre">repository&gt;/Pynq-Z1/vivado/base</span></code></div></blockquote>
<div class="section" id="block-diagram-tcl">
<h3>Block Diagram Tcl<a class="headerlink" href="#block-diagram-tcl" title="Permalink to this headline">¶</a></h3>
<p>The tcl for the Vivado block diagram should also be exported with the bitstream. This allows information about the overlay to be parsed into Python (e.g. list of IPs in the overlay). See the next section for details on how to query the tcl file.</p>
<p>You can use a custom tcl file to build your project, or block diagram, but custom tcl files may not be parsed correctly. You should use Vivado to export the tcl for the block diagram. This should ensure it can be parsed correctly in Python.</p>
<p>To generate the tcl for the Block Diagram from the Vivado GUI:</p>
<blockquote>
<div><ul class="simple">
<li>Click <strong>File &gt; Export &gt; Block Design</strong></li>
</ul>
</div></blockquote>
<p>Or, run the following in the tcl console:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">write_bd_tcl</span>
</pre></div>
</div>
<p>The tcl filename should match the .bit filename. E.g. my_overlay.bit and my_overlay.tcl</p>
<p>The tcl is parsed when the overlay is instantiated (not when it is downloaded).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pynq</span> <span class="kn">import</span> <span class="n">Overlay</span>
<span class="n">ol</span> <span class="o">=</span> <span class="n">Overlay</span><span class="p">(</span><span class="s2">&quot;base.bit&quot;</span><span class="p">)</span> <span class="c1"># tcl is parsed here</span>
</pre></div>
</div>
<p>An error will be displayed if a tcl is not available when attempting to download an overlay, or if the tcl filename does not match the .bit file name.</p>
</div>
<div class="section" id="ip-dict">
<h3>ip_dict<a class="headerlink" href="#ip-dict" title="Permalink to this headline">¶</a></h3>
<p>The Overlay package generates a dictionary called ip_dict containing the names of IP in a specific overlay (e.g. <cite>base.bit</cite>).
The dictionary can be used to reference an IP by name in your Python code, rather than by a hard coded address. It can also check the IP available in an overlay.</p>
<p>To show the IP dictionary of the overlay, run the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pynq</span> <span class="kn">import</span> <span class="n">Overlay</span>
<span class="n">OL</span> <span class="o">=</span> <span class="n">Overlay</span><span class="p">(</span><span class="s2">&quot;base.bit&quot;</span><span class="p">)</span>
<span class="n">OL</span><span class="o">.</span><span class="n">ip_dict</span>
</pre></div>
</div>
<p>Each entry in this IP dictionary that is returned is a key-value pair.</p>
<p>E.g.:</p>
<p><code class="docutils literal"><span class="pre">'SEG_mb_bram_ctrl_1_Mem0':</span> <span class="pre">['0x40000000',</span> <span class="pre">'0x10000',</span> <span class="pre">None]</span></code></p>
<p>Note, this parses the tcl file that was exported with the bitstream. It does not do check the overlay currently running in the PL.</p>
<p>The key of the entry is the IP instance name; all the IP instance names are parsed from the <cite>*.tcl</cite> file (e.g. <cite>base.tcl</cite>) in the address segment section. The value of the entry is a list of 3 items:</p>
<blockquote>
<div><ul class="simple">
<li>The first item shows the base address of the addressable IP (hex).</li>
<li>The second item shows the address range in bytes (hex).</li>
<li>The third item records the state associated with the IP. It is <cite>None</cite> by default, but can be user defined.</li>
</ul>
</div></blockquote>
<p>Similarly, the PL package can be used to find the addressable IPs currently in the programmable logic:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pynq</span> <span class="kn">import</span> <span class="n">PL</span>
<span class="n">PL</span><span class="o">.</span><span class="n">ip_dict</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="existing-overlays">
<h2><a class="toc-backref" href="#id4">Existing Overlays</a><a class="headerlink" href="#existing-overlays" title="Permalink to this headline">¶</a></h2>
<p>The <em>base</em> overlay is included in the Pynq repository and can be found here:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">&lt;GitHub</span> <span class="pre">repository&gt;/Pynq-Z1/vivado/base</span></code></div></blockquote>
<p>A makefile exists in each folder that can be used to rebuild the Vivado project and generate the bitstream for the overlay. The bitstream and tcl for the overlay are available on the board (base.bit is loaded by default when the board boots), and in the project repository:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">&lt;GitHub</span> <span class="pre">Repository&gt;/Pynq-Z1/bitstream/</span></code></div></blockquote>
<p>Vivado must be installed to design and build overlays. Building an existing overlay design allows the project to be opened in Vivado and examined, or modified to create a new overlay.</p>
<a class="reference internal image-reference" href="_images/vivado_base_overlay.JPG"><img alt="_images/vivado_base_overlay.JPG" class="align-center" src="_images/vivado_base_overlay.JPG" style="width: 400.0px; height: 244.5px;" /></a>
</div>
<div class="section" id="interfacing-to-an-overlay">
<h2><a class="toc-backref" href="#id5">Interfacing to an overlay</a><a class="headerlink" href="#interfacing-to-an-overlay" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mmio">
<h3>MMIO<a class="headerlink" href="#mmio" title="Permalink to this headline">¶</a></h3>
<p>PYNQ includes the <em>MMIO</em> Python class to simplify communication between the Zynq PS and PL. Once the overlay has been created, and the memory map is known, the <em>MMIO</em> can be used to access memory mapped locations in the PL.</p>
<p>The Python code for the MMIO can be viewed here:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">&lt;GitHub</span> <span class="pre">Repository&gt;/python/pynq/mmio.py</span></code></div></blockquote>
<p>The MMIO class can access an area of memory in the PL by specifying the start address, and the range. E.g. The following code allows access to memory mapped locations in the PL from 0x40000000 to 0x40010000 (<cite>SEG_mb_bram_ctrl_1_Mem0</cite>):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pynq</span> <span class="kn">import</span> <span class="n">MMIO</span>

<span class="c1"># an IP is located at 0x40000000</span>
<span class="n">myip</span> <span class="o">=</span> <span class="n">MMIO</span><span class="p">(</span><span class="mh">0x40000000</span><span class="p">,</span><span class="mh">0x10000</span><span class="p">)</span>

<span class="c1"># Read from the IP at offset 0</span>
<span class="n">myip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>In the example above, any accesses outside the address range 0x10000 (65535 bytes) will cause an exception in the MMIO package. The designer must also be careful to ensure that addresses accessed by the MMIO have something mapped in the PL. Remember that custom peripherals exist in the address space, and even if and address range is mapped by the MMIO, there may not be anything connected to specific addresses, or they may be read only or write only. Invalid accesses to the PL will cause system errors and will likely crash a Jupyter kernel.</p>
<p>When creating the python driver for a new hardware function, the MMIO can be wrapped inside a Python module.</p>
</div>
<div class="section" id="zynq-gpios">
<h3>Zynq GPIOs<a class="headerlink" href="#zynq-gpios" title="Permalink to this headline">¶</a></h3>
<p>GPIO between the Zynq PS and PL can be used by Python code as a control interface to overlays.  The information about a GPIO is kept in the GPIO dictionary of an overlay, similar to the <em>ip_dict</em> discussed above.</p>
<p>The following code can be used to get the dictionary for a bitstream:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pynq</span> <span class="kn">import</span> <span class="n">Overlay</span>
<span class="n">ol</span> <span class="o">=</span> <span class="n">Overlay</span><span class="p">(</span><span class="s2">&quot;base.bit&quot;</span><span class="p">)</span>
<span class="n">ol</span><span class="o">.</span><span class="n">gpio_dict</span>
</pre></div>
</div>
<p>A GPIO dictionary entry is a key, value pair, where <em>value</em> is a list of two items. An example of the entry in a GPIO dictionary:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">'mb_1_reset/Din':</span> <span class="pre">[0,</span> <span class="pre">None]</span></code></div></blockquote>
<p>The key is the GPIO instance name (<em>mb_1_reset/Din</em>). GPIO instance names are read and parsed from the Vivado <cite>*.tcl</cite> file (e.g. <cite>base.tcl</cite>).</p>
<p>The <em>value</em> is a list of 2 items:</p>
<blockquote>
<div><ul class="simple">
<li>The first item shows the index of the GPIO (0).</li>
<li>The second item (<em>None</em>) shows the state of the GPIO. It is <cite>None</cite> by default, but can be user defined.</li>
</ul>
</div></blockquote>
<p>The following code can be used to get the dictionary for GPIO currently in the FPGA fabric:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pynq</span> <span class="kn">import</span> <span class="n">PL</span>
<span class="n">pl</span> <span class="o">=</span> <span class="n">PL</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gpio_dict</span>
</pre></div>
</div>
</div>
<div class="section" id="cffi">
<h3>CFFI<a class="headerlink" href="#cffi" title="Permalink to this headline">¶</a></h3>
<p>CFFI (C Foreign Function Interface) provides a simple way to interface with C code from Python. The CFFI package is preinstalled in the PYNQ image. It supports an inline ABI (Application Binary Interface) compatibility mode, which allows you to dynamically load and run functions from executable modules, and an API mode, which allows you to build C extension modules.</p>
<p>The following example taken from <a class="reference external" href="http://docs.python-guide.org/en/latest/scenarios/clibs/">http://docs.python-guide.org/en/latest/scenarios/clibs/</a> shows the ABI inline mode, calling the C function <code class="docutils literal"><span class="pre">strlen()</span></code> in from Python</p>
<p>C function prototype:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">size_t</span> <span class="nf">strlen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">);</span>
</pre></div>
</div>
<p>The C function prototype is passed to <code class="docutils literal"><span class="pre">cdef()</span></code>, and can be called using <code class="docutils literal"><span class="pre">clib</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cffi</span> <span class="kn">import</span> <span class="n">FFI</span>
<span class="n">ffi</span> <span class="o">=</span> <span class="n">FFI</span><span class="p">()</span>
<span class="n">ffi</span><span class="o">.</span><span class="n">cdef</span><span class="p">(</span><span class="s2">&quot;size_t strlen(const char*);&quot;</span><span class="p">)</span>
<span class="n">clib</span> <span class="o">=</span> <span class="n">ffi</span><span class="o">.</span><span class="n">dlopen</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="n">length</span> <span class="o">=</span> <span class="n">clib</span><span class="o">.</span><span class="n">strlen</span><span class="p">(</span><span class="n">b</span><span class="s2">&quot;String to be evaluated.&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
</pre></div>
</div>
<p>C functions inside a shared library can be called from Python using the C Foreign Function Interface (CFFI). The shared library can be compiled online using the CFFI from Python, or it can be compiled offline.</p>
<p>For more information on CFFI and shared libraries refer to:</p>
<p><a class="reference external" href="http://cffi.readthedocs.io/en/latest/overview.html">http://cffi.readthedocs.io/en/latest/overview.html</a></p>
<p><a class="reference external" href="http://www.tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html">http://www.tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html</a></p>
<p>To see examples in PYNQ on how to use CFFI, refer to the CMA class or the Audio class, both located:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">&lt;GitHub</span> <span class="pre">Repository&gt;/pynq/drivers</span></code></div></blockquote>
</div>
</div>
<div class="section" id="packaging-overlays">
<h2><a class="toc-backref" href="#id6">Packaging overlays</a><a class="headerlink" href="#packaging-overlays" title="Permalink to this headline">¶</a></h2>
<p>An overlay, tcl, and Python can be placed anywhere in the filesystem, but this is not good practice.</p>
<p>The default location for the base PYNQ overlay and tcl is :</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">&lt;GitHub</span> <span class="pre">Repository&gt;/Pynq-Z1/bitstream</span></code></div></blockquote>
<p>The PYNQ Python can be found here:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">&lt;GitHub</span> <span class="pre">Repository&gt;/python/pynq</span></code></div></blockquote>
<p>You can fork PYNQ from github, and add Python code to the PYNQ package. However, for custom overlays, you can create your own repository and package it to allow other users to install your overlay using pip.</p>
<p>There are different ways to package a project for installation with pip. One example is provided below.</p>
<p>See pip install for more details, and more packaging options.
<a class="reference external" href="https://pip.pypa.io/en/stable/reference/pip_install">https://pip.pypa.io/en/stable/reference/pip_install</a></p>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>The following example assume an overlay that exists in the root of a GitHub repository.</p>
<p>Assume the repository has the following structure:</p>
<blockquote>
<div><ul>
<li><dl class="first docutils">
<dt>notebook/</dt>
<dd><ul class="first last simple">
<li>new_overlay.ipynb</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>new_overlay/</dt>
<dd><ul class="first last simple">
<li>new_overlay.bit</li>
<li>new_overlay.tcl</li>
<li>__init.py</li>
<li>new_overlay.py</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">readme.md</p>
</li>
<li><p class="first">license</p>
</li>
</ul>
</div></blockquote>
<p>Add a setup.py to the root of your repository. This file will imports the necessary packages, and specifies some setup instructions for your package including the package name, version, url, and files to include.</p>
<p>Example setup.py :</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">new_overlay</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;new_overlay&quot;</span><span class="p">,</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">new_overlay</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://github.com/your_github/new_overlay&#39;</span><span class="p">,</span>
    <span class="n">license</span> <span class="o">=</span> <span class="s1">&#39;All rights reserved.&#39;</span><span class="p">,</span>
    <span class="n">author</span> <span class="o">=</span> <span class="s2">&quot;Your Name&quot;</span><span class="p">,</span>
    <span class="n">author_email</span> <span class="o">=</span> <span class="s2">&quot;your@email.com&quot;</span><span class="p">,</span>
    <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;new_overlay&#39;</span><span class="p">],</span>
    <span class="n">package_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;*.bit&#39;</span><span class="p">,</span><span class="s1">&#39;*.tcl&#39;</span><span class="p">,</span><span class="s1">&#39;*.py&#39;</span><span class="p">,</span><span class="s1">&#39;*.so&#39;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;New custom overlay for PYNQ-Z1&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>package_data</strong> specifies which files will be installed as part of the package.</p>
<p>From a terminal, the new package can be installed by running:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">sudo pip install --upgrade &#39;git+https://github.com/your_github/new_overlay&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-overlays">
<h2><a class="toc-backref" href="#id7">Using Overlays</a><a class="headerlink" href="#using-overlays" title="Permalink to this headline">¶</a></h2>
<p>The PL can be dynamically reconfigured with new overlays as the system is running.</p>
<p>Loading overlays can be done in Python using the Overlay class:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">&lt;GitHub</span> <span class="pre">Repository&gt;/python/pynq/pl.py</span></code></div></blockquote>
<p>The bitstream can then be downloaded from Python:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pynq</span> <span class="kn">import</span> <span class="n">Overlay</span>
<span class="n">ol</span> <span class="o">=</span> <span class="n">Overlay</span><span class="p">(</span><span class="s2">&quot;base.bit&quot;</span><span class="p">)</span>
<span class="n">ol</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="11_python_package.html" class="btn btn-neutral float-right" title="pynq Package" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="9c_base_overlay_audio.html" class="btn btn-neutral" title="Audio using the Base Overlay" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Xilinx.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>